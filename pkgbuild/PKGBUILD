# Maintainer: Barnab√© <barnabedikartola@gmail.com>

pkgname=biglinux-systemd-swap
pkgver=$(date +%y.%m.%d)
pkgrel=$(date +%H%M)
pkgdesc="Script for creating hybrid swap space from zram swaps, swap files and swap partitions - biglinux fork"
arch=('any')
url="https://github.com/biglinux/biglinux-systemd-swap"
license=('GPL3')
depends=('python' 'python-systemd' 'python-sysv_ipc' 'util-linux')
makedepends=('git')
provides=('systemd-swap')
conflicts=('systemd-swap-git' 'systemd-swap' 'auto-zram-and-swappiness' 'systemd-oomd-defaults')
backup=('etc/systemd/swap.conf')
source=("git+${url}.git")
sha256sums=('SKIP')
replaces=('auto-zram-and-swappiness' 'systemd-oomd-defaults')
install=pkgbuild.install

package() {
    cd ${srcdir}/${pkgname}
    make DESTDIR="$pkgdir" install
    cp "${srcdir}/${pkgname}/src/pre-systemd-swap" "${pkgdir}/usr/bin/"
    cp "${srcdir}/${pkgname}/src/auto-hugepages" "${pkgdir}/usr/bin/"
    cp "${srcdir}/${pkgname}/include/pre-systemd-swap.service" "${pkgdir}/usr/lib/systemd/system/"
    mkdir -p "${pkgdir}/etc/sysctl.d/"
    echo 'vm.overcommit_memory=1
vm.overcommit_ratio=300
vm.swappiness=5
vm.vfs_cache_pressure=10
vm.page-cluster=0' > "${pkgdir}/etc/sysctl.d/91-swap.conf"
}
