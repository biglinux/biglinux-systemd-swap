# Configuration for systemd-swap
# This file is part of systemd-swap.
# See swap.conf(5) for details.

################################################################################
# Swap Mode
#
# auto            - Auto-detect best mode (default)
#                   - btrfs/ext4/xfs -> zswap + swapfc
#                   - others -> zram only
# zswap+swapfc    - Zswap + swap files (best for desktop/btrfs)
# zram+swapfc     - Zram + swap files (good for low RAM)
# zram            - Zram only (no disk swap)
# manual          - Use explicit settings below
################################################################################

swap_mode=auto

################################################################################
# Zswap Settings (used in zswap+swapfc mode)
# This space is used for uncompressed memory. Since we have around a 3x compression ratio,
# a system with 8 GB of RAM and 45% compressed memory usage can reach roughly 10.8 GB of
# swap in RAM.
#
# However, keep in mind that 3.6 GB of RAM is no longer actually being used as regular RAM,
# but rather as compressed cache. In practice, this is equivalent to around 15.2 GB total
# (4.4 GB of RAM + 10.8 GB of swap compressed in RAM).
#
# 45% is a high value, but the kernel automatically manages when it is better to move swap
# to storage, freeing up RAM, or when it is better to simply deallocate this memory.
#
# In addition, the system can automatically create swap files, allowing it to manage when
# to move swap to storage. This makes it possible to use a few more gigabytes of swap when needed.
################################################################################

zswap_compressor=zstd            # Compression algo: zstd, lz4, lzo
zswap_max_pool_percent=45        # Max RAM for compressed pool
zswap_zpool=zsmalloc             # Allocator
zswap_shrinker_enabled=1         # Proactively move cold pages to disk
zswap_accept_threshold=90        # Restart accepting pages when pool drops to X%

################################################################################
# Zram Settings (used in zram modes)
# Unlike zswap, with zram the reserved space corresponds to the virtual size of the
# swap being created, not to a usage limit based on a percentage of physical memory.
# Therefore, 90% in zram does not represent a higher virtual swap value than 45% in zswap.
################################################################################

zram_size=90%                    # Size of zram device (e.g., 50%, 1G)
zram_alg=zstd                    # Compression algo
zram_prio=32767                  # Priority (highest)

# Zram Writeback (optional, off by default)
# Moves incompressible/idle pages to backing storage
zram_writeback=0
zram_writeback_size=1G           # Initial backing file size
zram_writeback_max_size=8G       # Max size
zram_writeback_threshold=50      # Trigger when zram is X% full

################################################################################
# SwapFC - Dynamic Swap Files (used in swapfc modes)
################################################################################

# Progressive Scaling: Start small, grow as needed
swapfc_enabled=1                 # Enable swap files
swapfc_path=/swapfc/swapfile     # Directory and filename prefix
swapfc_chunk_size=512M           # Base size
swapfc_max_chunk_size=64G        # Max single file size ( Theoretically be up to 16 TB or more )
swapfc_max_count=32              # Max number of files ( Kernel limit is 32 )
swapfc_scaling_step=4            # Double size every X files
                                 # Doubles every 4 files e.g. 512M -> 512M -> 512M -> 512M -> 1024M -> 1024M...

# Triggers
swapfc_free_ram_perc=35          # Create swap when free RAM < X%
swapfc_free_swap_perc=25         # Create more when free swap < X%
swapfc_remove_free_swap_perc=55  # Remove files when free swap > X%

# MGLRU Anti-Thrashing (Kernel 6.1+)
# Protect working set for X ms. 0 to disable.
mglru_min_ttl_ms=1000

# Sparse Files
# Create files that only use disk space when actually written to.
# With pre-allocated space there should be a performance gain, however
# more storage space will be reserved for swap, so the performance gain may not be noticeable.
# swapfc_use_sparse_disable=1    # Uncomment to pre-allocate all space
