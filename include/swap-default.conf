#  This file is part of systemd-swap.
#
# Configuration for systemd-swap daemon.
# See swap.conf(5) for details.

################################################################################
# Swap Mode - How swap is configured
#
# auto            - Auto-detect: btrfs/ext4/xfs → zswap+swapfc, other → zram only
# zswap+swapfc    - Zswap cache + swap files (default for btrfs)
# zram+swapfc     - Zram (fast) + swap files for overflow
# zram            - Zram only (no disk swap)
# manual          - Use explicit settings below (legacy mode)
################################################################################

swap_mode=auto

################################################################################
# Zswap - Compressed RAM cache for swap pages
# Used in zswap+swapfc mode or manual with zswap_enabled=1
#
# zswap compresses pages before writing to swap, reducing I/O.
# Requires a backing swap device (swap file or partition).
################################################################################

zswap_compressor=zstd            # lzo lz4 zstd lzo-rle lz4hc (zstd = best balance)
zswap_max_pool_percent=45        # Max % of RAM for compressed pool (30-50 typical)
zswap_zpool=zsmalloc             # Memory allocator (zsmalloc only, z3fold/zbud deprecated)
zswap_shrinker_enabled=1         # Move cold pages to disk proactively (default since 6.8)
zswap_accept_threshold=90        # Accept pages again after pool was full (%)

################################################################################
# Zram - Compressed RAM disk
# Used in zram+swapfc, zram-only modes, or manual with zram_enabled=1
#
# zram creates a compressed block device in RAM for swap
# Faster than zswap - ideal for desktop systems
################################################################################

# zram_size supports: 1G, 512M, 50%, 100% (full RAM)
zram_size=80%               # Size of zram device
zram_alg=zstd               # Compression: lzo lz4 zstd lzo-rle lz4hc
zram_prio=32767             # Swap priority (highest = used first)

# Zram writeback: move idle/incompressible pages to disk
# Requires CONFIG_ZRAM_WRITEBACK in kernel
# When enabled with empty dev, auto-creates sparse file + loop device
zram_writeback=0            # 0=disabled, 1=enabled
zram_writeback_dev=         # Backing device (partition or empty for auto loop)
zram_writeback_size=1G      # Size of auto-created backing file

################################################################################
# SwapFC - Dynamic swap file management
# Supports: btrfs, ext4, xfs (auto-detected)
# Used in zram+swapfc, zswap+swapfc modes, or manual with swapfc_enabled=1
#
# Creates swap files on-demand as memory pressure increases.
# Files are pre-allocated with fallocate for stability.
################################################################################

# swapfc_chunk_size supports: 1G, 512M, 10% (percentage of RAM)
swapfc_chunk_size=512M           # Size of each swap file (512M = good balance)
swapfc_max_count=32              # Maximum number of swap files
swapfc_min_count=1               # Minimum (1 for zswap backing)
swapfc_free_ram_perc=35          # Create swap when free RAM < this %
swapfc_free_swap_perc=25         # Create more swap when free swap < this %
swapfc_remove_free_swap_perc=55  # Remove swap when free swap > this %
swapfc_priority=50               # Swap priority (decreases per file)
swapfc_path=/swapfc/swapfile     # Path for swap files
swapfc_frequency=1               # Check interval in seconds

# File allocation mode:
# Pre-allocated (default): Uses fallocate, reserves disk space upfront.
# This is the recommended mode for stability under memory pressure.
# swapfc_use_sparse=1            # Uncomment for thin provisioning (advanced, less stable)

# Btrfs compression mode (experimental, btrfs only):
# Uses loop device over file on compressed btrfs subvolume.
# Enables double compression: zswap (RAM) + btrfs zstd (disk).
swapfc_use_btrfs_compression=0

################################################################################
# MGLRU - Multi-Gen LRU tuning (kernel 6.1+)
# Protects working set from premature eviction during memory pressure.
# If min_ttl_ms > 0, pages are protected for that duration before eviction.
# This prevents thrashing at the cost of triggering OOM killer if memory
# cannot be maintained. 0 = disabled (kernel default).
################################################################################

mglru_min_ttl_ms=1000            # Protection time in ms (0=disabled, 1000=recommended)

################################################################################
# Enable/disable settings
# zswap_enabled: Set to 0 to disable zswap (default: 1, enabled when not using zram)
# zram_enabled: Only used in manual mode
# swapfc_enabled: Only used in manual mode
################################################################################

zswap_enabled=1
zram_enabled=0
swapfc_enabled=0
swapd_auto_swapon=0
