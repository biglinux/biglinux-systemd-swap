# Configuration for systemd-swap
# This file is part of systemd-swap.
# See swap.conf(5) for details.

################################################################################
# Swap Mode
#
# auto            - Auto-detect best mode (default)
#                   - btrfs/ext4/xfs -> zswap + swapfc
#                   - others -> zram only
# zswap+swapfc    - Zswap + swap files (best for desktop/btrfs)
# zram+swapfc     - Zram + swap files (good for low RAM)
# zram            - Zram only (no disk swap)
# manual          - Use explicit settings below
################################################################################

swap_mode=auto

################################################################################
# Zswap Settings (used in zswap+swapfc mode)
# This space is used for uncompressed memory. Since we have around a 3x compression ratio,
# a system with 8 GB of RAM and 45% compressed memory usage can reach roughly 10.8 GB of
# swap in RAM.
#
# However, keep in mind that 3.6 GB of RAM is no longer actually being used as regular RAM,
# but rather as compressed cache. In practice, this is equivalent to around 15.2 GB total
# (4.4 GB of RAM + 10.8 GB of swap compressed in RAM).
#
# 45% is a high value, but the kernel automatically manages when it is better to move swap
# to storage, freeing up RAM, or when it is better to simply deallocate this memory.
#
# In addition, the system can automatically create swap files, allowing it to manage when
# to move swap to storage. This makes it possible to use a few more gigabytes of swap when needed.
################################################################################

zswap_compressor=lz4             # Compression algo: lz4 (fastest), zstd, lzo
zswap_max_pool_percent=50        # Max RAM for compressed pool (50% = ~20GB swap in RAM with compression)
zswap_zpool=z3fold               # Allocator (z3fold uses less RAM overhead than zsmalloc)
zswap_shrinker_enabled=1         # Proactively move cold pages to disk
zswap_accept_threshold=85        # Restart accepting pages when pool drops to X% (more aggressive)

################################################################################
# Zram Settings (used in zram modes)
# Unlike zswap, with zram the reserved space corresponds to the virtual size of the
# swap being created, not to a usage limit based on a percentage of physical memory.
# Therefore, 90% in zram does not represent a higher virtual swap value than 45% in zswap.
################################################################################

zram_size=90%                    # Size of zram device (e.g., 50%, 1G)
zram_alg=zstd                    # Compression algo
zram_prio=32767                  # Priority (highest)

# Zram Writeback (optional, off by default)
# Moves incompressible/idle pages to backing storage
zram_writeback=0
zram_writeback_size=1G           # Initial backing file size
zram_writeback_max_size=8G       # Max size
zram_writeback_threshold=50      # Trigger when zram is X% full

################################################################################
# SwapFC - Dynamic Swap Files (used in swapfc modes)
################################################################################

# Progressive Scaling: Start small, grow as needed
swapfc_enabled=1                 # Enable swap files
swapfc_path=/swapfc/swapfile     # Directory and filename prefix
swapfc_chunk_size=1G             # Base size (larger chunks = less overhead on NVMe/SSD)
swapfc_max_chunk_size=64G        # Max single file size ( Theoretically be up to 16 TB or more )
swapfc_max_count=16              # Max number of files (reduced to avoid fragmentation)
swapfc_scaling_step=3            # Double size every X files
                                 # Doubles every 3 files e.g. 1G -> 1G -> 1G -> 2G -> 2G -> 2G -> 4G...

# Triggers (optimized to reduce thrashing)
swapfc_free_ram_perc=20          # Create swap when free RAM < X% (rely on zswap first)
swapfc_free_swap_perc=40         # Create more when free swap < X% (more proactive)
swapfc_remove_free_swap_perc=70  # Remove files when free swap > X% (cleanup sooner)

# MGLRU Anti-Thrashing (Kernel 6.1+)
# Protect working set for X ms. 0 to disable.
# Higher value = better protection against thrashing, improves desktop responsiveness
mglru_min_ttl_ms=5000

# Sparse Files
# Pre-allocated files (sparse disabled) provide better performance under memory pressure.
# Sparse files save disk space but may cause allocation delays during swap usage.
# For NVMe/SSD systems with available space, pre-allocation is recommended.
swapfc_use_sparse_disable=1      # Pre-allocate space for better performance
