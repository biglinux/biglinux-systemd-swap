# Recommended kernel tuning for zram/zswap swap management.
# Install to /etc/sysctl.d/91-memory.conf
# SPDX-License-Identifier: GPL-3.0-or-later
#
# These parameters optimize memory management for systems using
# zram (compressed RAM swap) or zswap (compressed cache + disk swap).
# Values are uniform — no RAM-size differentiation needed.
#
# NOTE: vm.min_free_kbytes is calculated dynamically by the
# pre-systemd-swap service (3% of RAM, max 512MB).

# ── Swap readahead ──
# Pages read per swap-in operation (2^N pages).
# 0 = page-at-a-time (optimal for zram: each page compressed individually).
# For zswap+disk: use 2 (4 pages = 16KB) to amortize disk I/O.
vm.page-cluster = 0

# ── Swappiness ──
vm.swappiness = 30

# ── Cache reclaim ──
# Balance VFS cache retention vs anonymous page reclaim.
# Default 100 aggressively reclaims directory/inode caches.
# 75 retains more VFS caches while still allowing reclaim.
vm.vfs_cache_pressure = 75

# ── Watermarks ──
# Gap between min/low/high watermarks (in 0.01% units).
# Default 10 (0.1%) is too tight for zram. 150 (1.5%) gives
# kswapd enough headroom to reclaim before OOM.
vm.watermark_scale_factor = 150

# Boost watermarks after fragmentation events for compaction recovery.
vm.watermark_boost_factor = 15000

# ── Dirty page writeback ──
# Flush dirty pages to disk early, freeing RAM before swap is needed.
# default background_ratio=10, ratio=20. Lowering frees memory sooner.
vm.dirty_background_ratio = 5
vm.dirty_ratio = 15

# ── Memory compaction ──
# Background defragmentation level. Lower avoids CPU waste when
# unmovable slab pages (zram zsmalloc, btrfs) make compaction futile.
vm.compaction_proactiveness = 20

# Eagerness to compact vs reclaim. Lower = more willing to compact.
vm.extfrag_threshold = 300

# ── Memory reserves ──
# Reserve for root/admin logins during OOM situations.
vm.admin_reserve_kbytes = 131072

# ── OOM killer ──
vm.oom_kill_allocating_task = 1
vm.panic_on_oom = 0
